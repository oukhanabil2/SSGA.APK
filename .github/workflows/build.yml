name: ULTIMATE SGA APK BUILD

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: üîç DEBUG - List files
      run: |
        echo "=== STRUCTURE DU PROJET ==="
        ls -la
        echo "=== FICHIERS PYTHON ==="
        ls -la *.py
        echo "=== BUILD SPEC ==="
        ls -la *.spec || echo "No spec file"
        
    - name: üì¶ Install Buildozer and dependencies
      run: |
        echo "üöÄ Installation de Buildozer..."
        pip install buildozer
        pip install cython==0.29.33
        
    - name: üõ†Ô∏è Install Android dependencies
      run: |
        echo "üì± Installation des outils Android..."
        sudo apt-get update
        sudo apt-get install -y \
          git autoconf build-essential \
          libffi-dev libssl-dev \
          python3-pip zip unzip \
          openjdk-11-jdk
        
    - name: üèóÔ∏è Build APK (FORCE MODE)
      run: |
        echo "üèóÔ∏è DEBUT DE LA COMPILATION..."
        echo "Cette √©tape devrait durer 45-60 minutes"
        
        # Forcer l'initialisation
        buildozer init --force
        
        # Lancer la compilation avec logs d√©taill√©s
        buildozer -v android debug 2>&1 | tee build.log &
        
        # Attendre et montrer la progression
        BUILD_PID=$!
        for i in {1..60}; do
          if ps -p $BUILD_PID > /dev/null; then
            echo "‚è≥ Compilation en cours... ($i/60 minutes)"
            sleep 60
          else
            break
          fi
        done
        
        # V√©rifier le r√©sultat
        if [ -f bin/*.apk ]; then
          echo "‚úÖ APK GENER√â AVEC SUCC√àS!"
          ls -la bin/
        else
          echo "‚ùå Aucun APK g√©n√©r√©"
          echo "=== DERNIERES LIGNES DU LOG ==="
          tail -50 build.log || echo "No build log"
        fi
        
    - name: üì± Upload APK if exists
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SGA-ULTIMATE-APK
        path: bin/*.apk
        retention-days: 30
        
    - name: üìÑ Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: build.log
        retention-days: 7
