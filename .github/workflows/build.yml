name: DEBUG SGA APK - CAPTURE ERREURS

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install Buildozer
      run: |
        pip install buildozer
        pip install cython==0.29.33
        
    - name: ğŸ› ï¸ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git autoconf build-essential \
          libffi-dev libssl-dev \
          python3-pip zip unzip \
          openjdk-11-jdk
          
    - name: ğŸ” DEBUG - Test Buildozer
      run: |
        echo "=== TEST BUILDozer ==="
        buildozer --version || echo "Buildozer non trouvÃ©"
        which buildozer || echo "Buildozer pas dans PATH"
        
    - name: ğŸ—ï¸ Build APK with ERROR CAPTURE
      run: |
        set -e  # ArrÃªter Ã  la premiÃ¨re erreur
        set -x  # Afficher toutes les commandes
        
        echo "=== INITIALISATION ==="
        buildozer init --force
        
        echo "=== COMPILATION ANDROID ==="
        # Forcer l'affichage complet des erreurs
        buildozer -v android debug || {
          echo "âŒ BUILD FAILED"
          echo "=== DERNIÃˆRE ERREUR ==="
          tail -100 .buildozer/logs/build.log || echo "No build log"
          exit 1
        }
        
    - name: ğŸ“± Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SGA-DEBUG-APK
        path: bin/*.apk
        
    - name: ğŸ“„ Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Buildozer-Logs
        path: .buildozer/logs/
        retention-days: 7
